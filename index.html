<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLU BARCODE GENERATOR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/ods.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
None>by BDK234</p>
        </div>
        
        <nav>
            <a href="#">
                <div>üè†</div>
                PLU Barcode Generator
            </a>
            <a href="barcodekarton.html">
                <div>üì¶</div>
                Barcode Karton
            </a>
            <a href="#">
                <div>üìä</div>
                Custom Barcode
                (COMING SOON)
            </a>
        </nav>
        
        <div>
            ¬© 2024 BDK234<br>
            Version 1.0
        </div>
    </div>

    <!-- Menu Overlay -->
    <div id="menuOverlay" onclick="closeMenu()"></div>

    <div>
        <div>
            <h1>PLU BARCODE GENERATOR</h1>
            <h1>VERSI STAND ALONE</h1>
            <h1>BY BDK234</h1>
            <div>
                Dibantu donate nya pak/bu untuk menghargai saya<br>
                <br>
                WARNING!!!!!! <br>
                saya bisa memblok penggunaan ini kapan saja. jadi tolong hargai!!
            </div>
        </div>

        <!-- Data Status Indicator -->
        <div id="dataStatus" style="display: none;">
        </div>

        <div>
            <div>Input PLU (satu atau lebih):</div>
            <div>
                <textarea id="searchInput" placeholder="Masukkan kode PLU...&#10;Satu PLU per baris" disabled></textarea>
            </div>
            <div>
                <button onclick="searchMultiplePLU()" id="searchBtn" disabled>Cari Semua</button>
                <button onclick="clearResults()">Bersihkan Hasil</button>
                <button onclick="window.print()">Cetak Semua</button>
                <button onclick="loadExcelData()" id="reloadBtn">üîÑ Reload Data</button>
            </div>
        </div>

        <!-- Slideshow Controls -->
        <div id="slideshowControls">
            <div id="slideInfo">PLU 1 dari 1</div>
            <div>
                <button onclick="toggleSlideshow()" id="slideshowBtn">Mulai Slideshow</button>
                <button onclick="prevSlide()">‚Üê Sebelumnya</button>
                <button onclick="nextSlide()">Selanjutnya ‚Üí</button>
            </div>
            <div>
                <label>Waktu per slide:</label>
                <select id="slideTime" onchange="updateSlideTime()">
                    <option value="1000">1 detik</option>
                    <option value="2000" selected>2 detik</option>
                    <option value="3000">3 detik</option>
                    <option value="4000">4 detik</option>
                    <option value="5000">5 detik</option>
                </select>
            </div>
            <div>
                <label>Animasi:</label>
                <select id="animationType" onchange="updateAnimationType()">
                    <option value="slide" selected>Slide (Geser)</option>
                    <option value="fade">Fade (Memudar)</option>
                </select>
            </div>
        </div>

        <div id="result"></div>
        
        <div>BDK234/2024</div>
    </div>

    <!-- Footer will be loaded by footer.js -->
    <div id="footer-container"></div>

    <!-- Load External Scripts -->
    <script src="menu.js"></script>
    <script src="footer.js"></script>

    <script>
        let excelData = [];
        let slideshowInterval = null;
        let currentSlide = 0;
        let slides = [];
        let slideTime = 2000; // default 2 detik
        let isSlideshow = false;
        let animationType = 'slide'; // default animation
        let isAnimating = false; // prevent rapid clicking

        // Menu functions
        function toggleMenu() {
            const menu = document.getElementById('slideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu.style.display === 'block') {
                closeMenu();
            } else {
                openMenu();
            }
        }

        function openMenu() {
            const menu = document.getElementById('slideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            menu.style.display = 'block';
            overlay.style.display = 'block';
        }

        function closeMenu() {
            const menu = document.getElementById('slideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            menu.style.display = 'none';
            overlay.style.display = 'none';
        }

        // Close menu when clicking on menu links
        document.querySelectorAll('nav a').forEach(item => {
            item.addEventListener('click', function(e) {
                closeMenu();
            });
        });

        // Close menu on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMenu();
            }
        });

        function cleanBarcode(barcode) {
            return String(barcode).replace(/\D/g, '');
        }

        function getDescription(item) {
            const descriptionKeys = [
                'DESKRIPSI', 'Deskripsi', 'deskripsi', 
                'DESCRIPTION', 'Description', 'description',
                'KETERANGAN', 'Keterangan', 'keterangan', 
                'NAMA', 'Nama', 'nama'
            ];

            for (let key of descriptionKeys) {
                if (item[key]) {
                    return item[key];
                }
            }

            return '-';
        }

        function getBarcodeValues(item) {
            const originalBarcode = item.BARCODE || item.Barcode || item.barcode || 
                                  String(item.PLU || item.plu);
            const cleanedBarcode = cleanBarcode(originalBarcode);
            
            return {
                original: originalBarcode,
                cleaned: cleanedBarcode || originalBarcode
            };
        }

        // Function to update data status
        function updateDataStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('dataStatus');
            
            const icons = {
                loading: 'üîÑ',
                success: '‚úÖ',
                error: '‚ùå'
            };
            
            statusDiv.innerHTML = `${icons[type]} ${message}`;
        }

        // Function to enable/disable input controls
        function setInputEnabled(enabled) {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            searchInput.disabled = !enabled;
            searchBtn.disabled = !enabled;
            
            if (enabled) {
                searchInput.placeholder = "Masukkan kode PLU...\nSatu PLU per baris";
            } else {
                searchInput.placeholder = "Menunggu data dimuat...";
            }
        }

        // Function to load Excel data automatically
        async function loadExcelData() {
            setInputEnabled(false);
            
            try {
                const response = await fetch('data/data2.ods');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Get the first worksheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    throw new Error('File kosong atau tidak ada data yang valid');
                }
                
                excelData = jsonData;
                
                updateDataStatus(`Data berhasil dimuat! Total: ${excelData.length} item`, 'success');
                document.getElementById('dataStatus').style.display = 'block';
                setInputEnabled(true);
                
                // Focus on search input
                document.getElementById('searchInput').focus();
                
            } catch (error) {
                console.error('Error loading Excel data:', error);
                updateDataStatus(`‚ùå Gagal memuat data: ${error.message}`, 'error');
                document.getElementById('dataStatus').style.display = 'block';
                setInputEnabled(false);
            }
        }

        // Auto-load data when page loads
        window.addEventListener('load', function() {
            loadExcelData();
        });

        function searchMultiplePLU() {
            const searchText = document.getElementById('searchInput').value.trim();
            const resultDiv = document.getElementById('result');

            resultDiv.innerHTML = '<div>Sedang mencari data...</div>';

            if (!excelData.length) {
                resultDiv.innerHTML = '<div>Data belum tersedia!</div>';
                return;
            }

            if (!searchText) {
                resultDiv.innerHTML = '<div>Masukkan kode PLU!</div>';
                return;
            }

            const searchValues = searchText.split('\n').filter(line => line.trim());
            const results = [];
            const notFound = [];

            searchValues.forEach(searchValue => {
                searchValue = searchValue.trim();
                if (searchValue) {
                    const foundItem = excelData.find(item => {
                        return Object.values(item).some(value => 
                            String(value).toLowerCase() === searchValue.toLowerCase()
                        );
                    });

                    if (foundItem) {
                        results.push(foundItem);
                    } else {
                        notFound.push(searchValue);
                    }
                }
            });

            displayResults(results, notFound);
        }

        function displayResults(results, notFound) {
            const resultDiv = document.getElementById('result');
            const slideshowControls = document.getElementById('slideshowControls');
            
            // Reset slideshow
            stopSlideshow();
            
            let html = '';

            // Hanya tampilkan result summary jika ada PLU yang tidak ditemukan
            if (notFound.length > 0) {
                html += '<div>';
                html += `
                    <div style="color: red;">
                        Tidak ditemukan (${notFound.length}): ${notFound.join(', ')}
                    </div>
                `;
                html += '</div>';
            }

            if (results.length > 0) {
                // Show slideshow controls if more than 1 result
                if (results.length > 1) {
                    slideshowControls.style.display = 'block';
                } else {
                    slideshowControls.style.display = 'none';
                }

                html += '<div>';
                html += '<div id="slidesWrapper">';
                
                results.forEach((item, index) => {
                    const barcodeValues = getBarcodeValues(item);
                    const showOriginal = barcodeValues.original !== barcodeValues.cleaned;
                    const description = getDescription(item);
                    
                    html += `
                        <div data-slide="${index}" style="border: 1px solid #ccc; padding: 20px; margin: 10px 0; text-align: center;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <th style="border: 1px solid #ccc; padding: 8px; background: #f0f0f0; width: 100px;">PLU</th>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${item.PLU || item.plu || '-'}</td>
                                </tr>
                                <tr>
                                    <th style="border: 1px solid #ccc; padding: 8px; background: #f0f0f0;">Barcode</th>
                                    <td style="border: 1px solid #ccc; padding: 8px;">
                                        ${barcodeValues.cleaned}
                                        ${showOriginal ? 
                                            `<div style="color: #666; font-size: 14px; margin-top: 2px; font-style: italic;">(Original: ${barcodeValues.original})</div>` 
                                            : ''}
                                    </td>
                                </tr>
                                <tr>
                                    <th style="border: 1px solid #ccc; padding: 8px; background: #f0f0f0;">Deskripsi</th>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${description}</td>
                                </tr>
                            </table>
                            <svg class="barcode-${barcodeValues.cleaned}-${index}"></svg>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                // Store slides data
                slides = results;
                currentSlide = 0;
                updateSlideInfo();
            } else if (notFound.length === 0) {
                // Jika tidak ada hasil dan tidak ada yang tidak ditemukan
                html += '<div>Tidak ada PLU yang dicari!</div>';
                slideshowControls.style.display = 'none';
            } else {
                // Jika semua PLU tidak ditemukan
                slideshowControls.style.display = 'none';
            }

            resultDiv.innerHTML = html;

            // Generate barcodes
            if (results.length > 0) {
                results.forEach((item, index) => {
                    const barcodeValues = getBarcodeValues(item);
                    try {
                        JsBarcode(`.barcode-${barcodeValues.cleaned}-${index}`, barcodeValues.cleaned, {
                            format: "CODE128",
                            width: 2,
                            height: 120,
                            displayValue: true
                        });
                    } catch (e) {
                        console.error('Error generating barcode:', e);
                    }
                });
                
                // Initialize slide position
                updateSlidePosition();
            }
        }

        // slide animation functions
        function updateSlidePosition() {
            const slidesWrapper = document.getElementById('slidesWrapper');
            if (!slidesWrapper) return;
            
            const items = slidesWrapper.querySelectorAll('[data-slide]');
            
            if (animationType === 'fade') {
                // For fade animation
                items.forEach((item, index) => {
                    if (index === currentSlide) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else {
                // For slide animation - show all but scroll to current
                items.forEach((item, index) => {
                    item.style.display = 'block';
                });
                
                if (items[currentSlide]) {
                    items[currentSlide].scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function updateAnimationType() {
            animationType = document.getElementById('animationType').value;
            updateSlidePosition();
        }

        // Slideshow functions
        function toggleSlideshow() {
            if (isSlideshow) {
                stopSlideshow();
            } else {
                startSlideshow();
            }
        }

        function startSlideshow() {
            if (slides.length <= 1) return;
            
            isSlideshow = true;
            document.getElementById('slideshowBtn').textContent = 'Stop Slideshow';
            
            slideshowInterval = setInterval(() => {
                nextSlide();
            }, slideTime);
        }

        function stopSlideshow() {
            isSlideshow = false;
            document.getElementById('slideshowBtn').textContent = 'Mulai Slideshow';
            
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
        }

        function nextSlide() {
            if (slides.length <= 1 || isAnimating) return;
            
            isAnimating = true;
            currentSlide = (currentSlide + 1) % slides.length;
            updateSlidePosition();
            updateSlideInfo();
            
            setTimeout(() => {
                isAnimating = false;
            }, 600);
        }

        function prevSlide() {
            if (slides.length <= 1 || isAnimating) return;
            
            isAnimating = true;
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
            updateSlidePosition();
            updateSlideInfo();
            
            setTimeout(() => {
                isAnimating = false;
            }, 600);
        }

        function updateSlideInfo() {
            const slideInfo = document.getElementById('slideInfo');
            if (slideInfo && slides.length > 0) {
                slideInfo.textContent = `Slide ${currentSlide + 1} dari ${slides.length}`;
            }
        }

        function updateSlideTime() {
            slideTime = parseInt(document.getElementById('slideTime').value);
            if (isSlideshow) {
                stopSlideshow();
                startSlideshow();
            }
        }

        function clearResults() {
            stopSlideshow();
            document.getElementById('result').innerHTML = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('slideshowControls').style.display = 'none';
            slides = [];
            currentSlide = 0;
            isAnimating = false;
        }

        // Keyboard shortcuts
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                searchMultiplePLU();
            }
        });

        // Add keyboard shortcut for reload
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                loadExcelData();
            }
        });

        // Initialize menu as hidden
        document.getElementById('slideMenu').style.display = 'none';
        document.getElementById('menuOverlay').style.display = 'none';
        document.getElementById('slideshowControls').style.display = 'none';
    </script>
</body>
</html>